<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình diễn ảnh nâng cao</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .gallery-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .frame-row {
            display: flex;
            gap: 20px;
        }
        
        .image-frame {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .frame-number {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 1;
        }
        
        .images-container {
            padding: 15px;
            overflow-x: auto;
            white-space: nowrap;
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .image-wrapper {
            display: inline-flex;
            position: relative;
            margin-right: 15px;
            height: 100%;
            align-items: center;
            justify-content: center;
        }
        
        .image-wrapper img {
            max-height: 100%;
            max-width: 100%;
            cursor: move;
            user-select: none;
            border: 1px solid #ddd;
            object-fit: contain;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-panel {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: auto;
        }
        
        .frame-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .frame-btn {
            padding: 8px 15px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: 80px;
            text-align: center;
        }
        
        .frame-btn.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .input-group button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .input-group button:hover {
            background-color: #45a049;
        }
        
        .row-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .row-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-row {
            background-color: #2196F3;
            color: white;
        }
        
        .remove-row {
            background-color: #f44336;
            color: white;
        }
        
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .password-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
        
        .password-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .password-content button {
            padding: 8px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .confirm-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        
        .contact-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #ff0000;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3), 
                        inset 0 0 0 2px white;
            z-index: 999;
            transition: transform 0.2s;
        }

        .contact-icon:hover {
            transform: scale(1.1);
        }

        .contact-popup {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 250px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
        }

        .contact-popup h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .contact-popup p {
            margin: 8px 0;
            color: #555;
        }

        .contact-popup .phone {
            color: #0066cc;
            text-decoration: underline;
            cursor: pointer;
        }

        .close-popup {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #777;
        }

        @media (max-width: 768px) {
            .frame-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                width: 100%;
            }
            
            .images-container {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BÁO GIÁ SẢN PHẨM THUỐC- DƯỢC MỸ PHẨM TỪ CÔNG TY IDECO</h1>
    </div>
    
    <div class="gallery-container" id="galleryContainer">
        <!-- Frame rows will be added dynamically -->
    </div>
    
    <div class="control-panel">
        <div class="frame-selector" id="frameSelector">
            <!-- Frame buttons will be added dynamically -->
        </div>
        
        <div class="input-group">
            <input type="text" id="imageUrl" placeholder="Nhập URL ảnh..." value="https://cdn.imgpile.com/f/w5EptnJ_xl.png">
            <button id="addImage">Thêm ảnh</button>
        </div>
        
        <div class="row-controls">
            <button class="add-row" id="addRow">Thêm hàng khung ảnh</button>
            <button class="remove-row" id="removeRow">Xóa hàng khung ảnh</button>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div class="password-modal" id="passwordModal">
        <div class="password-content">
            <h3>Nhập mật khẩu</h3>
            <input type="password" id="passwordInput" placeholder="Nhập mật khẩu">
            <div>
                <button class="confirm-btn" id="confirmPassword">Xác nhận</button>
                <button class="cancel-btn" id="cancelPassword">Hủy</button>
            </div>
        </div>
    </div>
    
    <div class="contact-icon" id="contactIcon">Liên hệ</div>
    
    <div class="contact-popup" id="contactPopup">
        <button class="close-popup" id="closePopup">&times;</button>
        <h3>Thông tin liên hệ</h3>
        <p><strong>Công ty:</strong> Công ty IDECO - Số 003 Carlion 5 -262/3 Lũy Bán Bính- P.Tân Phú- Tp.HCM</p>
        <p><strong>Người liên hệ:</strong> MS Nguyễn Hương</p>
        <p><strong>Điện thoại:</strong> <span class="phone" id="phoneNumber">0385600436</span></p>
    </div>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA3J07uTDbBody3reGIcDW7aYCWeTVMAlQ",
            authDomain: "xemanh-15ee9.firebaseapp.com",
            projectId: "xemanh-15ee9",
            storageBucket: "xemanh-15ee9.appspot.com",
            messagingSenderId: "53856714766",
            appId: "1:53856714766:web:badb27b8c76e19ec6f3c5f",
            measurementId: "G-7XM50LTXTW"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // DOM elements
        const imageUrlInput = document.getElementById('imageUrl');
        const addImageBtn = document.getElementById('addImage');
        const frameSelector = document.getElementById('frameSelector');
        const galleryContainer = document.getElementById('galleryContainer');
        const addRowBtn = document.getElementById('addRow');
        const removeRowBtn = document.getElementById('removeRow');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPassword = document.getElementById('confirmPassword');
        const cancelPassword = document.getElementById('cancelPassword');
        const contactIcon = document.getElementById('contactIcon');
        const contactPopup = document.getElementById('contactPopup');
        const closePopup = document.getElementById('closePopup');
        const phoneNumber = document.getElementById('phoneNumber');
        
        // Variables
        const CORRECT_PASSWORD = "minhtriet1973";
        let selectedFrame = null;
        let currentRows = 1;
        const framesPerRow = 3;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let initialX = 0;
        let initialY = 0;
        let currentDraggingImg = null;
        let currentDraggingFrameId = null;
        let currentDraggingImgIndex = null;
        let pendingAction = null;
        let pendingFrameId = null;
        let pendingImgIndex = null;
        
        // Initialize app
        function init() {
            // Load initial data from Firebase
            loadFromFirebase();
            
            // Create initial row
            addNewRow();
            
            // Set up event listeners
            addImageBtn.addEventListener('click', addImage);
            addRowBtn.addEventListener('click', addNewRow);
            removeRowBtn.addEventListener('click', () => showPasswordModal('removeRow'));
            confirmPassword.addEventListener('click', checkPassword);
            cancelPassword.addEventListener('click', hidePasswordModal);
            
            // Contact event listeners
            contactIcon.addEventListener('click', () => {
                contactPopup.style.display = 'block';
            });
            
            closePopup.addEventListener('click', () => {
                contactPopup.style.display = 'none';
            });
            
            phoneNumber.addEventListener('click', () => {
                const phone = phoneNumber.textContent.replace(/\s/g, '');
                window.location.href = `tel:${phone}`;
            });
            
            // Close popup when clicking outside
            document.addEventListener('click', (e) => {
                if (!contactPopup.contains(e.target) && e.target !== contactIcon) {
                    contactPopup.style.display = 'none';
                }
            });
        }
        
        // Password functions
        function showPasswordModal(action, frameId = null, imgIndex = null) {
            pendingAction = action;
            pendingFrameId = frameId;
            pendingImgIndex = imgIndex;
            passwordModal.style.display = 'flex';
            passwordInput.value = '';
            passwordInput.focus();
        }
        
        function hidePasswordModal() {
            passwordModal.style.display = 'none';
        }
        
        function checkPassword() {
            if (passwordInput.value === CORRECT_PASSWORD) {
                executePendingAction();
                hidePasswordModal();
            } else {
                alert("Mật khẩu không đúng!");
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        function executePendingAction() {
            if (!pendingAction) return;

            switch(pendingAction) {
                case 'removeImage':
                    if (pendingFrameId && pendingImgIndex !== null) {
                        removeImage(pendingFrameId, pendingImgIndex);
                    }
                    break;
                case 'removeRow':
                    removeLastRow();
                    break;
            }
            
            // Reset pending action
            pendingAction = null;
            pendingFrameId = null;
            pendingImgIndex = null;
        }
        
        // Load data from Firebase
        function loadFromFirebase() {
            database.ref('gallery').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Update rows count
                    currentRows = data.rows || 1;
                    
                    // Rebuild the gallery
                    rebuildGallery();
                    
                    // Load images for each frame
                    if (data.frames) {
                        for (const frameId in data.frames) {
                            const frameData = data.frames[frameId];
                            const frameElement = document.getElementById(`frame-${frameId}`);
                            
                            if (frameElement && frameData.images) {
                                const imagesContainer = frameElement.querySelector('.images-container');
                                imagesContainer.innerHTML = '';
                                
                                frameData.images.forEach((imgData, index) => {
                                    const imgWrapper = createImageWrapper(imgData.url, imgData.x, imgData.y, frameId, index);
                                    imagesContainer.appendChild(imgWrapper);
                                    
                                    // Adjust image size after loading
                                    const img = imgWrapper.querySelector('img');
                                    img.onload = function() {
                                        adjustImageSize(img);
                                    };
                                });
                            }
                        }
                    }
                }
            });
        }
        
        // Adjust image size to fit container
        function adjustImageSize(img) {
            const container = img.parentElement.parentElement;
            const containerHeight = container.clientHeight - 30; // account for padding
            
            // Calculate aspect ratio
            const aspectRatio = img.naturalWidth / img.naturalHeight;
            
            // Adjust based on container height
            if (img.naturalHeight > containerHeight) {
                img.style.height = `${containerHeight}px`;
                img.style.width = 'auto';
            } else {
                img.style.height = 'auto';
                img.style.width = 'auto';
            }
        }
        
        // Rebuild the gallery UI
        function rebuildGallery() {
            // Clear existing gallery
            galleryContainer.innerHTML = '';
            frameSelector.innerHTML = '';
            
            // Create frame selector buttons
            for (let row = 1; row <= currentRows; row++) {
                for (let col = 1; col <= framesPerRow; col++) {
                    const frameNum = (row - 1) * framesPerRow + col;
                    const frameId = `frame${frameNum}`;
                    
                    const frameBtn = document.createElement('button');
                    frameBtn.className = 'frame-btn';
                    frameBtn.textContent = `${frameNum}`;
                    frameBtn.dataset.frame = frameId;
                    frameBtn.addEventListener('click', () => selectFrame(frameId));
                    
                    frameSelector.appendChild(frameBtn);
                }
            }
            
            // Create gallery rows
            for (let row = 1; row <= currentRows; row++) {
                const rowElement = document.createElement('div');
                rowElement.className = 'frame-row';
                
                for (let col = 1; col <= framesPerRow; col++) {
                    const frameNum = (row - 1) * framesPerRow + col;
                    const frameId = `frame${frameNum}`;
                    
                    const frameElement = document.createElement('div');
                    frameElement.className = 'image-frame';
                    frameElement.id = `frame-${frameId}`;
                    
                    // Add frame number indicator
                    const frameNumber = document.createElement('div');
                    frameNumber.className = 'frame-number';
                    frameNumber.textContent = frameNum;
                    frameElement.appendChild(frameNumber);
                    
                    const imagesContainer = document.createElement('div');
                    imagesContainer.className = 'images-container';
                    
                    frameElement.appendChild(imagesContainer);
                    rowElement.appendChild(frameElement);
                }
                
                galleryContainer.appendChild(rowElement);
            }
            
            // Select first frame by default
            if (currentRows > 0) {
                selectFrame('frame1');
            }
        }
        
        // Select a frame
        function selectFrame(frameId) {
            // Update selected frame
            selectedFrame = frameId;
            
            // Update active button
            document.querySelectorAll('.frame-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.frame === frameId);
            });
        }
        
        // Add new image to selected frame
        function addImage() {
            if (!selectedFrame) return;
            
            const imageUrl = imageUrlInput.value.trim();
            if (!imageUrl) return;
            
            // Get current images in the frame
            const frameRef = database.ref(`gallery/frames/${selectedFrame}/images`);
            frameRef.once('value').then((snapshot) => {
                const images = snapshot.val() || [];
                
                // Add new image
                images.push({
                    url: imageUrl,
                    x: 0,
                    y: 0
                });
                
                // Update in Firebase
                frameRef.set(images).then(() => {
                    imageUrlInput.value = '';
                });
            });
        }
        
        // Create image wrapper element
        function createImageWrapper(src, x = 0, y = 0, frameId, imgIndex) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            
            const img = document.createElement('img');
            img.src = src;
            img.style.transform = `translate(${x}px, ${y}px)`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image';
            removeBtn.innerHTML = '&times;';
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showPasswordModal('removeImage', frameId, imgIndex);
            });
            
            // Drag events
            img.addEventListener('mousedown', (e) => startDrag(e, img, frameId, imgIndex));
            img.addEventListener('touchstart', (e) => startDragTouch(e, img, frameId, imgIndex));
            
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            return wrapper;
        }
        
        // Remove an image
        function removeImage(frameId, imgIndex) {
            const frameRef = database.ref(`gallery/frames/${frameId}/images`);
            frameRef.once('value').then((snapshot) => {
                const images = snapshot.val() || [];
                if (imgIndex >= 0 && imgIndex < images.length) {
                    images.splice(imgIndex, 1);
                    return frameRef.set(images);
                }
                return Promise.reject("Invalid image index");
            }).then(() => {
                console.log('Image removed successfully');
            }).catch(error => {
                console.error('Error removing image:', error);
            });
        }
        
        // Add new row of frames
        function addNewRow() {
            currentRows++;
            updateRowsInFirebase();
        }
        
        // Remove last row of frames
        function removeLastRow() {
            if (currentRows <= 1) {
                alert("Không thể xóa hàng cuối cùng!");
                return;
            }

            const firstFrameInLastRow = (currentRows - 1) * framesPerRow + 1;
            const lastFrameInLastRow = currentRows * framesPerRow;
            
            const updates = {};
            for (let i = firstFrameInLastRow; i <= lastFrameInLastRow; i++) {
                updates[`gallery/frames/frame${i}`] = null;
            }
            
            // Giảm số hàng trước khi cập nhật Firebase
            currentRows--;
            updates['gallery/rows'] = currentRows;
            
            database.ref().update(updates).then(() => {
                console.log('Row removed successfully');
            }).catch(error => {
                console.error('Error removing row:', error);
                // Khôi phục số hàng nếu có lỗi
                currentRows++;
            });
        }
        
        // Update rows count in Firebase
        function updateRowsInFirebase() {
            database.ref('gallery/rows').set(currentRows);
        }
        
        // Drag functions
        function startDrag(e, img, frameId, imgIndex) {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            // Get current position from transform
            const transform = img.style.transform;
            const match = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
            initialX = match ? parseFloat(match[1]) : 0;
            initialY = match ? parseFloat(match[2]) : 0;
            
            currentDraggingImg = img;
            currentDraggingFrameId = frameId;
            currentDraggingImgIndex = imgIndex;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            e.preventDefault();
        }
        
        function startDragTouch(e, img, frameId, imgIndex) {
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                isDragging = true;
                dragStartX = touch.clientX;
                dragStartY = touch.clientY;
                
                const transform = img.style.transform;
                const match = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                initialX = match ? parseFloat(match[1]) : 0;
                initialY = match ? parseFloat(match[2]) : 0;
                
                currentDraggingImg = img;
                currentDraggingFrameId = frameId;
                currentDraggingImgIndex = imgIndex;
                
                document.addEventListener('touchmove', dragTouch, { passive: false });
                document.addEventListener('touchend', endDrag);
                e.preventDefault();
            }
        }
        
        function drag(e) {
            if (isDragging && currentDraggingImg) {
                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                
                currentDraggingImg.style.transform = `translate(${initialX + dx}px, ${initialY + dy}px)`;
                e.preventDefault();
            }
        }
        
        function dragTouch(e) {
            if (isDragging && currentDraggingImg && e.touches.length === 1) {
                const touch = e.touches[0];
                const dx = touch.clientX - dragStartX;
                const dy = touch.clientY - dragStartY;
                
                currentDraggingImg.style.transform = `translate(${initialX + dx}px, ${initialY + dy}px)`;
                e.preventDefault();
            }
        }
        
        function endDrag() {
            if (isDragging && currentDraggingImg && currentDraggingFrameId !== null && currentDraggingImgIndex !== null) {
                // Get final position
                const transform = currentDraggingImg.style.transform;
                const match = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                const x = match ? parseFloat(match[1]) : 0;
                const y = match ? parseFloat(match[2]) : 0;
                
                // Update in Firebase
                const frameRef = database.ref(`gallery/frames/${currentDraggingFrameId}/images/${currentDraggingImgIndex}`);
                frameRef.update({
                    x: x,
                    y: y
                });
                
                // Clean up
                isDragging = false;
                currentDraggingImg = null;
                currentDraggingFrameId = null;
                currentDraggingImgIndex = null;
                
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', endDrag);
                document.removeEventListener('touchmove', dragTouch);
                document.removeEventListener('touchend', endDrag);
            }
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>
